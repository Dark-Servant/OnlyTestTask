#### Решение тестового задания для ООО "Онли"

1. В bash-консоли на сервере с чистым (или нет, главное, чтобы были пользователи) порталом Битрикс24 под пользователем bitrix выполнить
   ```bash
   cd /home/bitrix/www/
   git clone https://github.com/Dark-Servant/OnlyTestTask.git local
   ```
   или, если уже есть папка `local`, то выполнить
   ```bash
   cd /home/bitrix/www/local
   git clone https://github.com/Dark-Servant/OnlyTestTask.git .only
   if ! [ -d modules ]; then mkdir modules; fi
   ln -s `pwd`/.only/modules/only.cars modules
   ```

2. В браузере на портале Битрикс24 перейти по адресу `/bitrix/admin/partner_modules.php?lang=ru` и установить модуль **Модуль "ООО Онли. Тестовое задание"**. Будут установлены
    - Тип инфоблока **ООО Онли**
    - инфоблок **Категории комфорта**
    - инфоблок **Автомобили** со свойствами **Водитель** и **Категория комфорта**
    - Highload-блок **Должности**
    - Highload-блок **Занятость автомобилей**
    - пользовательское поле **Должность** для пользователей
    - пункт меню [**ООО Онли: тестовое задание**](./images/1740370045847.png)

3. На портале желательно иметь уже существующих пользователей, далее надо перейти по [`/bitrix/admin/user_admin.php`](./images/1740369436832.png), выбрать любого пользователя и добавить ему пользовательское поле **Должность** - [шаг 1](./images/1740369663053.png), [шаг 2](./images/1740369738722.png). И сохранить данные выбранного пользователя

4. В bash-консоли на сервере с порталом Битрикс24 выполнить
   - если репозиторий был загружен как папка `/home/bitrix/www/local` (1-й вариант загрузки репозитория), то
     ```bash
     cd /home/bitrix/www/local/php_interface/filldata
     ```
   - если репозиторий был загружен как папка `/home/bitrix/www/local/.only` (2-й вариант загрузки репозитория), то
     ```bash
     cd /home/bitrix/www/local/.only/php_interface/filldata
     ```
   
   далее выполнить `php -f index.php`. Будут заполнены тестовыми данными все установленные инфоблоки, Highload-блок и пользовательское поле **Должность** для пользователей

5. Теперь можно тестировать компонент `/home/bitrix/www/local/components/only.cars/carlistbytime` при переходе по пункту меню [**ООО Онли: тестовое задание**](./images/1740370045847.png)
6. Если при переходе по пункту меню будет что-то вроде [**У вас нет автомобилей, чтобы узнать какие свободны на время**](./images/1740370773797.png), то
   - надо открыть [Highload-блок **Должности**](./images/1740370860938.png) и выбрать ту должность, у которой есть **Категории комфорта**
   - открыть страницу своего пользователя в административной части и выбрать нужное значение в [пользовательском поле **Должность**](./images/1740371305641.png)
7. Для тестирования компонента
   - можно добавлять записи в [Highload-блок **Занятость автомобилей**](./images/1740371427866.png)
   - на странице при переходе по пункту меню [**ООО Онли: тестовое задание**](./images/1740370045847.png) можно использовать GET-параметры
     - **date_start**=YYYY-MM-ДД ЧЧ:ММ
     - **date_finish**=YYYY-MM-ДД ЧЧ:ММ

     а так же параметры
     - **model_name** и **model_id** для фильтрации по модели (часть названия или конкретный идентификатор)
     - **driver_name** и **driver_id** для фильтрации по водителю (часть имени или конкретный идентификатор)
     - **comfort_name** и **comfort_id** для фильтрации по категории комфорта (часть имени или конкретный идентификатор)

#### Компонент carlistbytime

Так как модуль при установке устанавливает данные, то идентификаторы этих данных он сохраняет у себя в настройках, доступ к которым идет через класс `Only\Cars\Helpers\OptionParameter`, который может группировать несколько параметров в одном параметре у модуля. При удалении модуль может использовать эти сохраненные идентификаторы, чтобы удалить за собой установленные данные. Внутри компонента **carlistbytime** доступ к идентификатором идет так
```php
use \Only\Cars\Helpers\OptionParameter;
...
$this->arResult['MDL_OPTIONS'] = new OptionParameter();
...
/**
 * Получение информации о идентификаторе Highload-блока через ->getHighloadBlock(ONLY_HL_USER_POSITION)
 */
$HLBlock = HighloadBlockTable::getByID($this->arResult['MDL_OPTIONS']->getHighloadBlock(ONLY_HL_USER_POSITION))->Fetch();
```

#### Удаление модуля с тестовым решением

Если удалить модуль, то он по-умолчанию уберет пункт меню [**ООО Онли: тестовое задание**](./images/1740370045847.png), компонент и раздел, но оставит инфоблоки, Highload-блоки и пользовательские поля. Для удаления всех данных надо в файле `local\modules\only.cars\install\index.php` найти константу `SAVE_OPTIONS_WHEN_DELETED` и поменять её значение на `false`